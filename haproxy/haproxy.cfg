# HAProxy L4 负载均衡 — 将 SDK 请求分发到多个 Collection 节点
# Docker Compose 环境使用，K8s 使用原生 Service

global
    maxconn 50000
    log stdout format raw local0

defaults
    mode tcp
    timeout connect 5s
    timeout client  60s
    timeout server  60s
    log global
    option tcplog

# SDK 埋点请求入口
frontend sdk_in
    bind *:80
    default_backend collection_nodes

backend collection_nodes
    balance roundrobin
    # Docker Compose DNS 会解析 collection 为所有实例 IP
    server-template collection 1-20 collection:80 check resolvers docker init-addr libc,none

resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry   1s
    hold other      10s
    hold refused    10s
    hold nx         10s
    hold timeout    10s
    hold valid      10s
    accepted_payload_size 8192

# 健康检查 + 统计页面
frontend stats
    mode http
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 5s
