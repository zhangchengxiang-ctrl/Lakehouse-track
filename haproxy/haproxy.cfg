# HAProxy HTTP 负载均衡 — 将 SDK 请求分发到多个 Collection 节点
# Docker Compose 环境使用，K8s 使用原生 Service
#
# 优化：从 TCP(L4) 升级为 HTTP(L7) 模式
#   · http-reuse always: 复用到后端的连接，避免每请求 TCP 三次握手
#   · option httpchk:    HTTP 健康检查，能发现 Nginx 应用层故障
#   · http-keep-alive:   前后端均保持长连接

global
    maxconn 50000
    log stdout format raw local0

defaults
    mode http
    option http-keep-alive
    # 复用后端连接：同一后端连接可被不同前端请求复用
    http-reuse always
    timeout http-request 10s
    timeout connect 5s
    timeout client  60s
    timeout server  60s
    timeout http-keep-alive 30s
    log global
    option httplog

# SDK 埋点请求入口
frontend sdk_in
    bind *:80
    default_backend collection_nodes

backend collection_nodes
    balance roundrobin
    # HTTP 健康检查（替代 TCP connect check，能发现 Nginx 应用层故障）
    option httpchk GET /health
    http-check expect status 200
    # Docker Compose DNS 会解析 collection 为所有实例 IP
    server-template collection 1-20 collection:80 check resolvers docker init-addr libc,none

resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry   1s
    hold other      10s
    hold refused    10s
    hold nx         10s
    hold timeout    10s
    hold valid      10s
    accepted_payload_size 8192

# 健康检查 + 统计页面
frontend stats
    mode http
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 5s
