# GeoIP 可选：需 bash scripts/lakehouse.sh install 后启用
enrichment_tables:
  geoip_table:
    type: "geoip"
    path: "/etc/vector/geoip/GeoLite2-City.mmdb"

sources:
  nginx_logs:
    type: "file"
    include: ["/var/log/nginx/access.log"]
    read_from: "beginning"

transforms:
  # 1. Nginx 日志解析 + 神策协议初步解码
  sa_decode:
    type: "remap"
    inputs: ["nginx_logs"]
    source: |
      # 解析 Nginx 原始行 (StellarTrace 格式)
      pattern = r'^"(?P<proxy_add_x_forwarded_for>[^"]*)" \+\+_ "(?P<msec>[^"]*)" \+\+_ "(?P<request_method>[^"]*)" \+\+_ "(?P<arg_gzip>[^"]*)" \+\+_ "(?P<arg_data>[^"]*)" \+\+_ "(?P<arg_data_list>[^"]*)" \+\+_ "(?P<request_body>[^"]*)" \+\+_ "(?P<http_user_agent>[^"]*)" \+\+_ "(?P<arg_project>[^"]*)" \+\+_ "(?P<http_cookie>[^"]*)" \+\+_ "(?P<arg_token>[^"]*)" \+\+_ "(?P<arg_ext>[^"]*)"'
      
      parsed_nginx, err = parse_regex(.message, pattern)
      if err == null {
          . = parsed_nginx
          
          # 提取远程地址
          if exists(.proxy_add_x_forwarded_for) && .proxy_add_x_forwarded_for != "-" {
              ips, err = split(.proxy_add_x_forwarded_for, ",")
              if err == null && length(ips) > 0 {
                  cleaned_ip, err = strip_whitespace(ips[0])
                  if err == null {
                      .remote_addr = cleaned_ip
                  }
              }
          }

          # 确定神策数据源
          raw_data = ""
          if .request_method == "POST" {
              if exists(.request_body) && .request_body != "-" {
                  body_parts, err = parse_key_value(.request_body)
                  if err == null {
                      raw_data = if exists(body_parts.data_list) { body_parts.data_list } else { body_parts.data }
                      if exists(body_parts.gzip) { .arg_gzip = body_parts.gzip }
                  }
              }
          } else if .request_method == "GET" {
              raw_data = if .arg_data != "-" { .arg_data } else { .arg_data_list }
          }

          # 解码神策数据
          if raw_data != "" && raw_data != "-" {
              if is_string(raw_data) {
                  raw_data = replace!(raw_data, "-", "%")
              } else {
                  raw_data = ""
              }
              decoded_raw = decode_percent(raw_data)
              raw_data = decoded_raw

              decoded_text, err = decode_base64(raw_data)
              if err == null {
                  if .arg_gzip == "1" {
                      decoded_text, err = decode_gzip(decoded_text)
                  }

                  if err == null {
                      .sa_payloads, err = parse_json(decoded_text)
                      # 如果解析失败，标记为脏数据
                      if err != null {
                          .is_valid = false
                          .error_type = "json_parse_error"
                      }
                  } else {
                      .is_valid = false
                      .error_type = "gzip_decode_error"
                  }
              } else {
                  .is_valid = false
                  .error_type = "base64_decode_error"
              }
          }
      } else {
          .is_valid = false
          .error_type = "nginx_regex_mismatch"
      }

  # 2. 展开多条事件 (使用 unnest 函数)
  sa_unnest:
    type: "remap"
    inputs: ["sa_decode"]
    source: |
      if is_array(.sa_payloads) {
          . = unnest!(.sa_payloads)
      }

  # 3. 字段标准化与清洗
  sa_normalize:
    type: "remap"
    inputs: ["sa_unnest"]
    source: |
      # unnest 之后，原来的 .sa_payloads 会变成单条对象
      if exists(.sa_payloads) && is_object(.sa_payloads) {
          payload = .sa_payloads
          
          .distinct_id = payload.distinct_id
          .event = payload.event
          .type = payload.type
          .project = if exists(payload.project) { payload.project } else { .arg_project }
          .properties = if exists(payload.properties) && is_object(payload.properties) { payload.properties } else { {} }
          
          # 合并 lib 信息
          if exists(payload.lib) && is_object(payload.lib) {
              .properties = merge!(.properties, payload.lib)
          }

          # DistinctId 简化处理（无缓存映射）
          login_id = if exists(payload.login_id) { payload.login_id } else { null }
          anonymous_id = if exists(payload.anonymous_id) { payload.anonymous_id } else { null }
          original_id = if exists(payload.original_id) { payload.original_id } else { null }

          is_login = false
          final_id = .distinct_id
          valid_id = false
          if is_string(login_id) && login_id != "" && login_id != "-1" {
              final_id = login_id
              is_login = true
              valid_id = true
          } else if is_string(anonymous_id) && anonymous_id != "" && anonymous_id != "-1" {
              final_id = anonymous_id
              valid_id = true
          } else if is_string(.distinct_id) && .distinct_id != "" && .distinct_id != "-1" {
              valid_id = true
          }

          if valid_id {
              .distinct_id = final_id
              .properties."$is_login_id" = is_login
              if is_string(login_id) { .login_id = login_id }
              if is_string(anonymous_id) { .anonymous_id = anonymous_id }
              if is_string(original_id) { .original_id = original_id }
          } else {
              .is_valid = false
              .error_type = "invalid_distinct_id"
          }

          # track_signup 补充 original_id
          if exists(.type) && .type == "track_signup" && is_string(original_id) && original_id != "" {
              .properties."$track_signup_original_id" = original_id
              .properties."$is_login_id" = true
          }

          # track_id_bind / track_id_unbind 简化处理
          if exists(.type) && .type == "track_id_bind" {
              if is_string(login_id) && login_id != "" && login_id != "-1" {
                  .distinct_id = login_id
                  .properties."$is_login_id" = true
                  if is_string(original_id) && original_id != "" {
                      .properties."$track_id_bind_original_id" = original_id
                  }
              }
          } else if exists(.type) && .type == "track_id_unbind" {
              if is_string(original_id) && original_id != "" {
                  .distinct_id = original_id
                  .properties."$is_login_id" = false
              }
          }

          # 标准化 OS 名称
          if exists(.properties."$os") && is_string(.properties."$os") {
              os_name = downcase(strip_whitespace!(.properties."$os"))
              if os_name == "iphone os" || os_name == "ios" {
                  .properties."$os" = "iOS"
              } else if os_name == "android" {
                  .properties."$os" = "Android"
              }
          }

          # Android 版本修正
          if exists(.properties."$os") && .properties."$os" == "Android" && exists(.properties."$os_version") && is_string(.properties."$os_version") {
              os_ver = strip_whitespace!(.properties."$os_version")
              if os_ver == "8.0" {
                  .properties."$os_version" = "8.0.0"
              } else if os_ver == "8.1" {
                  .properties."$os_version" = "8.1.0"
              }
          }

          # JS SDK 的 URL host 提取
          if exists(.properties."$lib") && is_string(.properties."$lib") && exists(.properties."$url") && is_string(.properties."$url") {
              lib_name = downcase(strip_whitespace!(.properties."$lib"))
              if lib_name == "js" || lib_name == "javascript" {
                  parsed_url, err = parse_url(.properties."$url")
                  if err == null && exists(parsed_url.host) {
                      .properties."$url_host" = parsed_url.host
                  }
              }
          }

          # profile 记录移除无用字段
          if exists(.type) && (.type == "profile_set" || .type == "profile_set_once") {
              del(.properties."$device_id_list")
              del(.properties."$is_deleted")
          }

          # JS profile 的 $first_visit_time 规范化
          if exists(.type) && (.type == "profile_set" || .type == "profile_set_once") {
              if exists(.properties."$first_visit_time") && exists(.properties."$lib") && is_string(.properties."$lib") {
                  lib_name = downcase(strip_whitespace!(.properties."$lib"))
                  if lib_name == "js" || lib_name == "javascript" {
                      if exists(.msec) {
                          msec_val, err = to_float(.msec)
                          if err == null {
                              first_time_ms = to_int(msec_val * 1000.0)
                              if first_time_ms > 0 {
                                  first_ts = from_unix_timestamp!(first_time_ms, unit: "milliseconds")
                                  .properties."$first_visit_time" = format_timestamp!(first_ts, format: "%Y-%m-%d %H:%M:%S.%3f")
                              }
                          }
                      }
                  }
              }
          }

          # 事件时长字段处理
          if exists(.properties.event_duration) {
              if is_integer(.properties.event_duration) || is_float(.properties.event_duration) {
                  if .properties.event_duration >= 0 {
                      .properties."$event_duration" = .properties.event_duration
                  }
              }
              del(.properties.event_duration)
          }

          # 记录属性键集合（用于后续属性元数据校验）
          if is_object(.properties) {
              props_keys, err = keys(.properties)
              if err == null {
                  .properties_keys = props_keys
              }
          }

          # 解析 User-Agent (仅在 normalize 阶段解析一次，节省 CPU)
          if exists(.http_user_agent) && .http_user_agent != "-" {
              if !exists(.properties."$user_agent") {
                  .properties."$user_agent" = .http_user_agent
              }

              if !match(.http_user_agent, r'^SensorsAnalytics') {
                  ua, err = parse_user_agent(.http_user_agent)
                  if err == null {
                      .ua_browser = if exists(ua.browser) { ua.browser.name } else { null }
                      .ua_os = if exists(ua.os) { ua.os.name } else { null }
                      .ua_device = if exists(ua.device) { ua.device.family } else { null }

                      if exists(ua.os) {
                          if exists(ua.os.name) && !exists(.properties."$os") {
                              .properties."$os" = ua.os.name
                          }
                          if exists(ua.os.version) && !exists(.properties."$os_version") {
                              .properties."$os_version" = ua.os.version
                          }
                      }
                      if exists(ua.browser) {
                          if exists(ua.browser.name) && !exists(.properties."$browser") {
                              .properties."$browser" = ua.browser.name
                          }
                          if exists(ua.browser.version) && !exists(.properties."$browser_version") {
                              .properties."$browser_version" = ua.browser.version
                          }
                      }
                      if exists(ua.device) {
                          if exists(ua.device.brand) && !exists(.properties."$manufacturer") {
                              .properties."$manufacturer" = ua.device.brand
                          }
                          if exists(ua.device.model) && !exists(.properties."$model") {
                              .properties."$model" = ua.device.model
                          }
                          if exists(ua.device.category) && !exists(.properties."$device_type") {
                              .properties."$device_type" = ua.device.category
                          }
                      }
                  }
              }

              # 简单 bot 标记
              if match(downcase(.http_user_agent), r'(bot|crawler|spider|scrapy)') {
                  .properties."$bot_name" = "bot"
              }
          }

          # 时间处理
          event_time_ms = 0
          if exists(payload.time) {
              time_val, err = to_int(payload.time)
              if err == null {
                  event_time_ms = time_val
              } else if exists(.msec) {
                  msec_val, err = to_float(.msec)
                  if err == null {
                      event_time_ms = to_int(msec_val * 1000.0)
                  }
              }
          } else if exists(.msec) {
              msec_val, err = to_float(.msec)
              if err == null {
                  event_time_ms = to_int(msec_val * 1000.0)
              }
          }
          
          if event_time_ms > 0 {
              .time = from_unix_timestamp!(event_time_ms, unit: "milliseconds")
              .timestamp = .time
              .dt = format_timestamp!(.time, format: "%Y-%m-%d")
              .hour = format_timestamp!(.time, format: "%H")
          }

          # event_group 三分：DEBUG(debug_*) / CORE($ 预置) / TRACE(自定义)
          .event_group = if match(string!(.event), r'^debug_') { "DEBUG" } else { if match(string!(.event), r'^\$') { "CORE" } else { "TRACE" } }
          .is_valid = if exists(.distinct_id) { true } else { false }
          
          # 清理中间字段
          del(.sa_payloads)
      } else if is_object(.) && exists(.distinct_id) {
          # 处理非数组（单条）的情况，sa_unnest 可能直接透传了对象
          if !exists(.time) && exists(.msec) {
              msec_val, err = to_float(.msec)
              if err == null {
                  event_time_ms = to_int(msec_val * 1000.0)
                  if event_time_ms > 0 {
                      .time = from_unix_timestamp!(event_time_ms, unit: "milliseconds")
                      .timestamp = .time
                      .dt = format_timestamp!(.time, format: "%Y-%m-%d")
                      .hour = format_timestamp!(.time, format: "%H")
                  }
              }
          }
          .is_valid = true
      }


  # 2. 早期过滤
  filter_sa_only:
    type: "filter"
    inputs: ["sa_normalize"]
    condition: 'exists(.distinct_id)'

  # 3. IP 解析 + 国家/省/市
  ip_geoip:
    type: "remap"
    inputs: ["filter_sa_only"]
    source: |
      if !exists(.properties) || !is_object(.properties) {
          .properties = {}
      }

      # 写入 $ip
      if (!exists(.properties."$ip") || .properties."$ip" == "") && exists(.remote_addr) {
          .properties."$ip" = .remote_addr
      }

      # GeoIP 增强
      if exists(.properties."$ip") && is_string(.properties."$ip") && .properties."$ip" != "" {
          geo_record, err = get_enrichment_table_record(
              table: "geoip_table",
              condition: {"ip": .properties."$ip"}
          )
          if err == null && is_object(geo_record) {
              .geoip = geo_record

              if (!exists(.properties."$country") || .properties."$country" == "") && exists(geo_record.country_name) {
                  .properties."$country" = geo_record.country_name
              }
              if (!exists(.properties."$province") || .properties."$province" == "") && exists(geo_record.region_name) {
                  .properties."$province" = geo_record.region_name
              }
              if (!exists(.properties."$city") || .properties."$city" == "") && exists(geo_record.city_name) {
                  .properties."$city" = geo_record.city_name
              }
          }
      }

  # 4. 最终校验逻辑
  final_check:
    type: "remap"
    inputs: ["ip_geoip"]
    source: |
      .redis_meta = null
      if exists(.geoip) && is_object(.geoip) {
          .geoip = encode_json(.geoip)
      }
      if exists(.properties) && is_object(.properties) {
          .properties = encode_json(.properties)
      }

  # 6. 过滤：仅保留有效埋点（有 sa_data 且解析成功），避免无埋点请求写入 S3
  filter_valid:
    type: "filter"
    inputs: ["final_check"]
    condition: '.is_valid == true'

sinks:
  to_minio:
    type: "aws_s3"
    inputs: ["filter_valid"]
    bucket: "paimon-lake"
    endpoint: "http://minio:9000"
    region: "us-east-1"
    auth:
      access_key_id: "minioadmin"
      secret_access_key: "minioadmin"
    compression: "none"
    encoding:
      codec: "json"
      only_fields: ["time", "distinct_id", "login_id", "anonymous_id", "original_id", "event", "type", "project", "properties", "properties_keys", "ua_browser", "ua_os", "ua_device", "geoip", "redis_meta", "remote_addr", "event_group", "dt", "hour"]
    # Flink FileSystem JSON 期望 JSONL（每行一个 JSON），而非 JSON 数组
    framing:
      method: "character_delimited"
      character_delimited:
        delimiter: "\n"
    key_prefix: "staging/dt={{dt}}/hour={{hour}}/"
    buffer:
      type: "disk"
      max_size: 107374182400
      when_full: "block"
    batch:
      max_bytes: 104857600
      max_events: 1000          # 增加批大小，减少小文件
      timeout_secs: 60          # 延长 flush 间隔，减少小文件生成
