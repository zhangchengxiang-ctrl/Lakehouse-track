apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-config
  namespace: paimon-lab
data:
  vector.yaml: |
    # GeoIP 可选：需下载 GeoLite2-City.mmdb 后取消注释
    # enrichment_tables:
    #   geoip_table:
    #     type: "geoip"
    #     path: "/var/lib/vector/GeoLite2-City.mmdb"

    sources:
      nginx_logs:
        type: "file"
        include: ["/var/log/nginx/access.log"]
        read_from: "beginning"

    transforms:
      # 1. 神策协议解码 + UA 解析
      sa_decode:
        type: "remap"
        inputs: ["nginx_logs"]
        source: |
          parsed, err = parse_json(.message)
          if err == null {
              . = parsed
              if exists(.http_user_agent) {
                  ua, err = parse_user_agent(.http_user_agent)
                  if err == null {
                      .ua_browser = if exists(ua.browser) { ua.browser.name } else { null }
                      .ua_os = if exists(ua.os) { ua.os.name } else { null }
                      .ua_device = if exists(ua.device) { ua.device.family } else { null }
                  }
              }
              
              if exists(.sa_data) {
                  decoded_str, err = decode_base64(.sa_data)
                  if err == null {
                      sa_payload, err = parse_json(decoded_str)
                      if err == null {
                          .distinct_id = sa_payload.distinct_id
                          .event = sa_payload.event
                          .type = sa_payload.type
                          .properties = if sa_payload.properties != null { encode_json(sa_payload.properties) } else { "{}" }
                          .project = sa_payload.project
                          if exists(sa_payload.time) {
                              .time = from_unix_timestamp!(to_int!(sa_payload.time), unit: "milliseconds")
                          } else if exists(.time) {
                              .time = parse_timestamp!(.time, format: "%+")
                          }
                          if exists(.time) {
                              .timestamp = .time
                          }
                          # event_group 三分：DEBUG(debug_*) / CORE($ 预置) / TRACE(自定义)
                          .event_group = if match(string!(.event), r'^debug_') { "DEBUG" } else { if match(string!(.event), r'^\$') { "CORE" } else { "TRACE" } }
                          .is_valid = true
                      }
                  }
              }
          }

      # 2. 早期过滤：仅处理有 sa_data 的埋点请求
      filter_sa_only:
        type: "filter"
        inputs: ["sa_decode"]
        condition: 'exists(.distinct_id)'

      # 3. IP 解析占位（GeoIP 需 GeoLite2-City.mmdb 后启用 enrichment_tables）
      ip_geoip:
        type: "remap"
        inputs: ["filter_sa_only"]
        source: |
          .geoip = null

      # 4. 最终校验逻辑 + geoip 转 STRING（Flink 期望）
      # 注：redis transform 已移除，白名单校验可改在 Flink 层实现
      final_check:
        type: "remap"
        inputs: ["ip_geoip"]
        source: |
          .redis_meta = null
          if exists(.geoip) && is_object(.geoip) {
              .geoip = encode_json(.geoip)
          }

      # 5. 过滤：仅保留有效埋点
      filter_valid:
        type: "filter"
        inputs: ["final_check"]
        condition: '.is_valid == true'

    sinks:
      to_minio:
        type: "aws_s3"
        inputs: ["filter_valid"]
        bucket: "paimon-lake"
        endpoint: "http://minio:9000"
        region: "us-east-1"
        auth:
          access_key_id: "minioadmin"
          secret_access_key: "minioadmin"
        compression: "none"
        encoding:
          codec: "json"
        key_prefix: "staging/dt=%F/"
        buffer:
          type: "disk"
          max_size: 107374182400
          when_full: "block"
        batch:
          max_bytes: 104857600
          max_events: 50
          timeout_secs: 10
